//--------------------------------------------------------
// ORTDC3377Model
// Created by Mark  A. Howe on Tue Aug 02 2005
// Code partially generated by the OrcaCodeWizard. Written by Mark A. Howe.
// Copyright (c) 2005 CENPA, University of Washington. All rights reserved.
//-----------------------------------------------------------
//This program was prepared for the Regents of the University of 
//Washington at the Center for Experimental Nuclear Physics and 
//Astrophysics (CENPA) sponsored in part by the United States 
//Department of Energy (DOE) under Grant #DE-FG02-97ER41020. 
//The University has certain rights in the program pursuant to 
//the contract and the program should not be copied or distributed 
//outside your organization.  The DOE and the University of 
//Washington reserve all rights in the program. Neither the authors,
//University of Washington, or U.S. Government make any warranty, 
//express or implied, or assume any liability or responsibility 
//for the use of this software.
//-------------------------------------------------------------

#pragma mark ***Imported Files

#import "ORTDC3377Model.h"
#import "ORHWWizParam.h"
#import "ORHWWizSelection.h"

#import "ORDataTypeAssigner.h"
#import "ORCamacCrateModel.h"
#import "ORCamacControllerCard.h"
#import "ORTest.h"

#pragma mark ***External Strings
NSString* ORTDC3377ModelTestsRunningChanged		= @"ORTDC3377ModelTestsRunningChanged";
NSString* ORTDC3377ModelTestingEnabledChanged	= @"ORTDC3377ModelTestingEnabledChanged";
NSString* ORTDC3377ModelTestingStatusChanged	= @"ORTDC3377ModelTestingStatusChanged";
NSString* ORTDC3377ModelDataShiftChanged		= @"ORTDC3377ModelDataShiftChanged";
NSString* ORTDC3377ModelPulsesToGenerateChanged = @"ORTDC3377ModelPulsesToGenerateChanged";
NSString* ORTDC3377ModelTestClockChanged		= @"ORTDC3377ModelTestClockChanged";
NSString* ORTDC3377ModelTestEnabledChanged		= @"ORTDC3377ModelTestEnabledChanged";
NSString* ORTDC3377ModelTimeoutChanged			= @"ORTDC3377ModelTimeoutChanged";
NSString* ORTDC3377ModelDataOffsetChanged		= @"ORTDC3377ModelDataOffsetChanged";
NSString* ORTDC3377ModelRequestDelayChanged		= @"ORTDC3377ModelRequestDelayChanged";
NSString* ORTDC3377ModelMaxFullScaleTimeChanged = @"ORTDC3377ModelMaxFullScaleTimeChanged";
NSString* ORTDC3377ModelMaxHitsPerTDCChanged	= @"ORTDC3377ModelMaxHitsPerTDCChanged";
NSString* ORTDC3377ModelFastFeraModeChanged		= @"ORTDC3377ModelFastFeraModeChanged";
NSString* ORTDC3377ModelPauseIntervalChanged	= @"ORTDC3377ModelPauseIntervalChanged";
NSString* ORTDC3377ModelClockUnitChanged		= @"ORTDC3377ModelClockUnitChanged";
NSString* ORTDC3377ModelPulseDelayChanged		= @"ORTDC3377ModelPulseDelayChanged";
NSString* ORTDC3377ModelPulseWidthChanged		= @"ORTDC3377ModelPulseWidthChanged";
NSString* ORTDC3377ModelSkipHeaderChanged		= @"ORTDC3377ModelSkipHeaderChanged";
NSString* ORTDC3377ModelMultiEventBufferModeChanged = @"ORTDC3377ModelMultiEventBufferModeChanged";
NSString* ORTDC3377ModelFeraModeChanged			= @"ORTDC3377ModelFeraModeChanged";
NSString* ORTDC3377ModelBothEdgesChanged		= @"ORTDC3377ModelBothEdgesChanged";
NSString* ORTDC3377ModelControlReg5Changed		= @"ORTDC3377ModelControlReg5Changed";
NSString* ORTDC3377ModelControlReg4Changed		= @"ORTDC3377ModelControlReg4Changed";
NSString* ORTDC3377ModelControlReg3Changed		= @"ORTDC3377ModelControlReg3Changed";
NSString* ORTDC3377ModelControlReg2Changed		= @"ORTDC3377ModelControlReg2Changed";
NSString* ORTDC3377ModelControlReg1Changed		= @"ORTDC3377ModelControlReg1Changed";
NSString* ORTDC3377ModelControlReg0Changed		= @"ORTDC3377ModelControlReg0Changed";
NSString* ORTDC3377ModelRunModeChanged			= @"ORTDC3377ModelRunModeChanged";
NSString* ORTDC3377SettingsLock					= @"ORTDC3377SettingsLock";

@interface ORTDC3377Model (private)
- (void) testCamacInterface;
- (void) fifoTest;
- (void) patternTest;
@end

@implementation ORTDC3377Model
- (id) init
{
	self = [super init];
	return self;
}

- (void) dealloc
{
    [testingEnabled release];
    [testingStatus release];
	[testSuit release];
	[super dealloc];
}

- (void) setUpImage
{
	[self setImage:[NSImage imageNamed:@"TDC3377"]];
}

- (void) makeMainController
{
	[self linkToController:@"ORTDC3377Controller"];
}

- (NSString*) helpURL
{
	return @"CAMAC/L3377.html";
}

#pragma mark ***Accessors
- (NSString*) shortName
{
	return @"TDC3377";
}
- (BOOL) testsRunning
{
    return testsRunning;
}

- (void) setTestsRunning:(BOOL)aTestsRunning
{
    testsRunning = aTestsRunning;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelTestsRunningChanged object:self];
}

- (NSMutableArray*) testingEnabled
{
    return testingEnabled;
}

- (void) setTestingEnabled:(NSMutableArray*)aTestingEnabled
{
    [[[self undoManager] prepareWithInvocationTarget:self] setTestingEnabled:testingEnabled];
    
    [aTestingEnabled retain];
    [testingEnabled release];
    testingEnabled = aTestingEnabled;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelTestingEnabledChanged object:self];
}

- (BOOL) testingIsEnabled:(int)index
{
	if(index<[testingEnabled count]){
		return [[testingEnabled objectAtIndex:index] intValue];
	}
	else return NO;
}

- (NSMutableArray*) testingStatus
{
    return testingStatus;
}

- (void) setTestingStatus:(NSMutableArray*)aTestingStatus
{
    [aTestingStatus retain];
    [testingStatus release];
    testingStatus = aTestingStatus;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelTestingStatusChanged object:self];
}

- (NSString*) testingStatus:(int)index
{
	if(index<[testingStatus count])return [testingStatus objectAtIndex:index];
	else return @"---";
}

- (BOOL) testingEnabled:(int)index
{
	if(index<[testingEnabled count])return [[testingEnabled objectAtIndex:index] boolValue];
	else return NO;
}


- (unsigned short) dataShift
{
    return dataShift;
}

- (void) setDataShift:(unsigned short)aDataShift
{
    [[[self undoManager] prepareWithInvocationTarget:self] setDataShift:dataShift];
    
    dataShift = aDataShift;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelDataShiftChanged object:self];
}

- (unsigned short) pulsesToGenerate
{
    return pulsesToGenerate;
}

- (void) setPulsesToGenerate:(unsigned short)aPulsesToGenerate
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPulsesToGenerate:pulsesToGenerate];
    
    pulsesToGenerate = aPulsesToGenerate;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelPulsesToGenerateChanged object:self];
}

- (unsigned short) testClock
{
    return testClock;
}

- (void) setTestClock:(unsigned short)aTestClock
{
    [[[self undoManager] prepareWithInvocationTarget:self] setTestClock:testClock];
    
    testClock = aTestClock;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelTestClockChanged object:self];
}

- (BOOL) testEnabled
{
    return testEnabled;
}

- (void) setTestEnabled:(BOOL)aTestEnabled
{
    [[[self undoManager] prepareWithInvocationTarget:self] setTestEnabled:testEnabled];
    
    testEnabled = aTestEnabled;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelTestEnabledChanged object:self];
}

- (unsigned short) timeOut
{
    return timeOut;
}

- (void) setTimeOut:(unsigned short)aTimeout
{
    [[[self undoManager] prepareWithInvocationTarget:self] setTimeOut:timeOut];
    
    timeOut = aTimeout;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelTimeoutChanged object:self];
}

- (unsigned short) dataOffset
{
    return dataOffset;
}

- (void) setDataOffset:(unsigned short)aOffset
{
    [[[self undoManager] prepareWithInvocationTarget:self] setDataOffset:dataOffset];
    
    dataOffset = aOffset;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelDataOffsetChanged object:self];
}

- (unsigned short) requestDelay
{
    return requestDelay;
}

- (void) setRequestDelay:(unsigned short)aRequestDelay
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRequestDelay:requestDelay];
    
    requestDelay = aRequestDelay;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelRequestDelayChanged object:self];
}

- (unsigned short) maxFullScaleTime
{
    return maxFullScaleTime;
}

- (void) setMaxFullScaleTime:(unsigned short)aMaxFullScaleTime
{
    [[[self undoManager] prepareWithInvocationTarget:self] setMaxFullScaleTime:maxFullScaleTime];
    
    maxFullScaleTime = aMaxFullScaleTime;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelMaxFullScaleTimeChanged object:self];
}

- (unsigned short) maxHitsPerTDC
{
    return maxHitsPerTDC;
}

- (void) setMaxHitsPerTDC:(unsigned short)aMaxHitsPerTDC
{
    [[[self undoManager] prepareWithInvocationTarget:self] setMaxHitsPerTDC:maxHitsPerTDC];
    
    maxHitsPerTDC = aMaxHitsPerTDC;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelMaxHitsPerTDCChanged object:self];
}

- (BOOL) fastFeraMode
{
    return fastFeraMode;
}

- (void) setFastFeraMode:(BOOL)aFastFeraMode
{
    [[[self undoManager] prepareWithInvocationTarget:self] setFastFeraMode:fastFeraMode];
    
    fastFeraMode = aFastFeraMode;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelFastFeraModeChanged object:self];
}

- (unsigned short) pauseInterval
{
    return pauseInterval;
}

- (void) setPauseInterval:(unsigned short)aPauseInterval
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPauseInterval:pauseInterval];
    
    pauseInterval = aPauseInterval;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelPauseIntervalChanged object:self];
}

- (unsigned short) clockUnit
{
    return clockUnit;
}

- (void) setClockUnit:(unsigned short)aClockUnit
{
    [[[self undoManager] prepareWithInvocationTarget:self] setClockUnit:clockUnit];
    
    clockUnit = aClockUnit;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelClockUnitChanged object:self];
}

- (unsigned short) pulseDelay
{
    return pulseDelay;
}

- (void) setPulseDelay:(unsigned short)aPulseDelay
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPulseDelay:pulseDelay];
    
    pulseDelay = aPulseDelay;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelPulseDelayChanged object:self];
}

- (unsigned short) pulseWidth
{
    return pulseWidth;
}

- (void) setPulseWidth:(unsigned short)aPulseWidth
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPulseWidth:pulseWidth];
    
    pulseWidth = aPulseWidth;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelPulseWidthChanged object:self];
}

- (BOOL) skipHeader
{
    return skipHeader;
}

- (void) setSkipHeader:(BOOL)aSkipHeader
{
    [[[self undoManager] prepareWithInvocationTarget:self] setSkipHeader:skipHeader];
    
    skipHeader = aSkipHeader;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelSkipHeaderChanged object:self];
}

- (BOOL) multiEventBufferMode
{
    return multiEventBufferMode;
}

- (void) setMultiEventBufferMode:(BOOL)aMultiEventBufferMode
{
    [[[self undoManager] prepareWithInvocationTarget:self] setMultiEventBufferMode:multiEventBufferMode];
    
    multiEventBufferMode = aMultiEventBufferMode;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelMultiEventBufferModeChanged object:self];
}

- (BOOL) feraMode
{
    return feraMode;
}

- (void) setFeraMode:(BOOL)aFeraMode
{
    [[[self undoManager] prepareWithInvocationTarget:self] setFeraMode:feraMode];
    
    feraMode = aFeraMode;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelFeraModeChanged object:self];
}

- (BOOL) bothEdges
{
    return bothEdges;
}

- (void) setBothEdges:(BOOL)aBothEdges
{
    [[[self undoManager] prepareWithInvocationTarget:self] setBothEdges:bothEdges];
    
    bothEdges = aBothEdges;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelBothEdgesChanged object:self];
}

- (unsigned short) controlReg5
{
    return controlReg5;
}

- (void) setControlReg5:(unsigned short)aControlReg5
{
    [[[self undoManager] prepareWithInvocationTarget:self] setControlReg5:controlReg5];
    
    controlReg5 = aControlReg5;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelControlReg5Changed object:self];
}

- (unsigned short) controlReg4
{
    return controlReg4;
}

- (void) setControlReg4:(unsigned short)aControlReg4
{
    [[[self undoManager] prepareWithInvocationTarget:self] setControlReg4:controlReg4];
    
    controlReg4 = aControlReg4;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelControlReg4Changed object:self];
}

- (unsigned short) controlReg3
{
    return controlReg3;
}

- (void) setControlReg3:(unsigned short)aControlReg3
{
    [[[self undoManager] prepareWithInvocationTarget:self] setControlReg3:controlReg3];
    
    controlReg3 = aControlReg3;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelControlReg3Changed object:self];
}

- (unsigned short) controlReg2
{
    return controlReg2;
}

- (void) setControlReg2:(unsigned short)aControlReg2
{
    [[[self undoManager] prepareWithInvocationTarget:self] setControlReg2:controlReg2];
    
    controlReg2 = aControlReg2;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelControlReg2Changed object:self];
}

- (unsigned short) controlReg1
{
    return controlReg1;
}

- (void) setControlReg1:(unsigned short)aControlReg1
{
    [[[self undoManager] prepareWithInvocationTarget:self] setControlReg1:controlReg1];
    
    controlReg1 = aControlReg1;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelControlReg1Changed object:self];
}

- (unsigned short) controlReg0
{
    return controlReg0;
}

- (void) setControlReg0:(unsigned short)aControlReg0
{
    [[[self undoManager] prepareWithInvocationTarget:self] setControlReg0:controlReg0];
    
    controlReg0 = aControlReg0;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelControlReg0Changed object:self];
}

- (int) controlMode
{
    return controlMode;
}

- (void) setControlMode:(int)aControlMode
{
    [[[self undoManager] prepareWithInvocationTarget:self] setControlMode:controlMode];
    
    controlMode = aControlMode;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelRunModeChanged object:self];
}

- (unsigned long) dataId { return dataId; }
- (void) setDataId: (unsigned long) DataId
{
    dataId = DataId;
}



#pragma mark ***Archival

- (id) initWithCoder:(NSCoder*)decoder
{
	self = [super initWithCoder:decoder];
	[[self undoManager] disableUndoRegistration];
	[self setTestingEnabled:[decoder decodeObjectForKey:@"ORTDC3377ModelTestingEnabled"]];
	[self setTestingStatus:[decoder decodeObjectForKey:@"ORTDC3377ModelTestingStatus"]];
	[self setDataShift:[decoder decodeIntForKey:@"ORTDC3377ModelDataShift"]];
	[self setPulsesToGenerate:[decoder decodeIntForKey:@"ORTDC3377ModelPulsesToGenerate"]];
	[self setTestClock:[decoder decodeIntForKey:@"ORTDC3377ModelTestClock"]];
	[self setTestEnabled:[decoder decodeBoolForKey:@"ORTDC3377ModelTestEnabled"]];
	[self setTimeOut:[decoder decodeIntForKey:@"ORTDC3377ModelTimeout"]];
	[self setDataOffset:[decoder decodeIntForKey:@"ORTDC3377ModelDataOffset"]];
	[self setRequestDelay:[decoder decodeIntForKey:@"ORTDC3377ModelRequestDelay"]];
	[self setMaxFullScaleTime:[decoder decodeIntForKey:@"ORTDC3377ModelMaxFullScaleTime"]];
	[self setMaxHitsPerTDC:[decoder decodeIntForKey:@"ORTDC3377ModelMaxHitsPerTDC"]];
	[self setFastFeraMode:[decoder decodeBoolForKey:@"ORTDC3377ModelFastFeraMode"]];
	[self setPauseInterval:[decoder decodeIntForKey:@"ORTDC3377ModelPauseInterval"]];
	[self setClockUnit:[decoder decodeIntForKey:@"ORTDC3377ModelClockUnit"]];
	[self setPulseDelay:[decoder decodeIntForKey:@"ORTDC3377ModelPulseDelay"]];
	[self setPulseWidth:[decoder decodeIntForKey:@"ORTDC3377ModelPulseWidth"]];
	[self setSkipHeader:[decoder decodeBoolForKey:@"ORTDC3377ModelSkipHeader"]];
	[self setMultiEventBufferMode:[decoder decodeBoolForKey:@"ORTDC3377ModelMultiEventBufferMode"]];
	[self setFeraMode:[decoder decodeBoolForKey:@"ORTDC3377ModelFeraMode"]];
	[self setBothEdges:[decoder decodeBoolForKey:@"ORTDC3377ModelBothEdges"]];
	[self setControlReg5:[decoder decodeIntForKey:@"ORTDC3377ModelControlReg5"]];
	[self setControlReg4:[decoder decodeIntForKey:@"ORTDC3377ModelControlReg4"]];
	[self setControlReg3:[decoder decodeIntForKey:@"ORTDC3377ModelControlReg3"]];
	[self setControlReg2:[decoder decodeIntForKey:@"ORTDC3377ModelControlReg2"]];
	[self setControlReg1:[decoder decodeIntForKey:@"ORTDC3377ModelControlReg1"]];
	[self setControlReg0:[decoder decodeIntForKey:@"ORTDC3377ModelControlReg0"]];
	[self setControlMode:[decoder decodeIntForKey:      @"ORTDC3377ModelControlMode"]];
	
	if(!testingStatus){
		NSMutableArray* aTestStatusArray = [NSMutableArray array];
		int i;
		for(i=0;i<kNum3377TDCTests;i++){
			[aTestStatusArray addObject:@"--"];
		}
		[self setTestingStatus:aTestStatusArray];
	}
	
	if(!testingEnabled){
		NSMutableArray* aTestEnabledArray = [NSMutableArray array];
		int i;
		for(i=0;i<kNum3377TDCTests;i++){
			[aTestEnabledArray addObject:[NSNumber numberWithBool:YES]];
		}
		[self setTestingEnabled:aTestEnabledArray];
	}
	
	
	[[self undoManager] enableUndoRegistration];
	return self;
}
- (void) encodeWithCoder:(NSCoder*)encoder
{
    [super encodeWithCoder:encoder];
    [encoder encodeObject:testingEnabled forKey:@"ORTDC3377ModelTestingEnabled"];
    [encoder encodeObject:testingStatus forKey:@"ORTDC3377ModelTestingStatus"];
    [encoder encodeInt:dataShift forKey:@"ORTDC3377ModelDataShift"];
    [encoder encodeInt:pulsesToGenerate forKey:@"ORTDC3377ModelPulsesToGenerate"];
    [encoder encodeInt:testClock forKey:@"ORTDC3377ModelTestClock"];
    [encoder encodeBool:testEnabled forKey:@"ORTDC3377ModelTestEnabled"];
    [encoder encodeInt:timeOut forKey:@"ORTDC3377ModelTimeout"];
    [encoder encodeInt:dataOffset forKey:@"ORTDC3377ModelDataOffset"];
    [encoder encodeInt:requestDelay forKey:@"ORTDC3377ModelRequestDelay"];
    [encoder encodeInt:maxFullScaleTime forKey:@"ORTDC3377ModelMaxFullScaleTime"];
    [encoder encodeInt:maxHitsPerTDC forKey:@"ORTDC3377ModelMaxHitsPerTDC"];
    [encoder encodeBool:fastFeraMode forKey:@"ORTDC3377ModelFastFeraMode"];
    [encoder encodeInt:pauseInterval forKey:@"ORTDC3377ModelPauseInterval"];
    [encoder encodeInt:clockUnit forKey:@"ORTDC3377ModelClockUnit"];
    [encoder encodeInt:pulseDelay forKey:@"ORTDC3377ModelPulseDelay"];
    [encoder encodeInt:pulseWidth forKey:@"ORTDC3377ModelPulseWidth"];
    [encoder encodeBool:skipHeader forKey:@"ORTDC3377ModelSkipHeader"];
    [encoder encodeBool:multiEventBufferMode forKey:@"ORTDC3377ModelMultiEventBufferMode"];
    [encoder encodeBool:feraMode forKey:@"ORTDC3377ModelFeraMode"];
    [encoder encodeBool:bothEdges forKey:@"ORTDC3377ModelBothEdges"];
    [encoder encodeInt:controlReg5 forKey:@"ORTDC3377ModelControlReg5"];
    [encoder encodeInt:controlReg4 forKey:@"ORTDC3377ModelControlReg4"];
    [encoder encodeInt:controlReg3 forKey:@"ORTDC3377ModelControlReg3"];
    [encoder encodeInt:controlReg2 forKey:@"ORTDC3377ModelControlReg2"];
    [encoder encodeInt:controlReg1 forKey:@"ORTDC3377ModelControlReg1"];
    [encoder encodeInt:controlReg0 forKey:@"ORTDC3377ModelControlReg0"];
    [encoder encodeInt:controlMode forKey:    @"ORTDC3377ModelControlMode"];
}

#pragma mark ¥¥¥HW Wizard
- (BOOL) hasParmetersToRamp
{
	return YES;
}

- (int) numberOfChannels
{
    return 32;
}

- (NSArray*) wizardParameters
{
    NSMutableArray* a = [NSMutableArray array];
	
    ORHWWizParam* p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Data Shift"];
    [p setFormat:@"##0" upperLimit:3 lowerLimit:0 stepSize:1 units:@"index"];
    [p setSetMethod:@selector(setDataShift:) getMethod:@selector(dataShift)];
    [a addObject:p];
	
    [a addObject:[ORHWWizParam boolParamWithName:@"Both Edges" setter:@selector(setBothEdges:) getter:@selector(bothEdges)]];
    [a addObject:[ORHWWizParam boolParamWithName:@"Fera Mode"  setter:@selector(setFeraMode:)  getter:@selector(feraMode)]];
    [a addObject:[ORHWWizParam boolParamWithName:@"MultiEvent Mode"  setter:@selector(setMultiEventBufferMode:)  getter:@selector(multiEventBufferMode)]];
    [a addObject:[ORHWWizParam boolParamWithName:@"Skip Header"  setter:@selector(setSkipHeader:)  getter:@selector(skipHeader)]];
    
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Pulse Width"];
    [p setFormat:@"##0" upperLimit:15 lowerLimit:0 stepSize:1 units:@"Clks"];
    [p setSetMethod:@selector(setPulseWidth:) getMethod:@selector(pulseWidth)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Pulse Delay"];
    [p setFormat:@"##0" upperLimit:15 lowerLimit:0 stepSize:1 units:@"Clks"];
    [p setSetMethod:@selector(setPulseDelay:) getMethod:@selector(pulseDelay)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Clock Units"];
    [p setFormat:@"##0" upperLimit:3 lowerLimit:0 stepSize:1 units:@"index"];
    [p setSetMethod:@selector(setClockUnit:) getMethod:@selector(clockUnit)];
    [a addObject:p];
    
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Pause Interval"];
    [p setFormat:@"##0" upperLimit:3 lowerLimit:0 stepSize:1 units:@"index"];
    [p setSetMethod:@selector(setPauseInterval:) getMethod:@selector(pauseInterval)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Max Hits"];
    [p setFormat:@"##0" upperLimit:16 lowerLimit:1 stepSize:1 units:@"# hits"];
    [p setSetMethod:@selector(setMaxHitsPerTDC:) getMethod:@selector(maxHitsPerTDC)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Max Full Scale"];
    [p setFormat:@"##0" upperLimit:0xffff lowerLimit:0 stepSize:1 units:@"x8ns"];
    [p setSetMethod:@selector(setMaxFullScaleTime:) getMethod:@selector(maxFullScaleTime)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Request Delay"];
    [p setFormat:@"##0" upperLimit:30 lowerLimit:0 stepSize:2 units:@"x8ns"];
    [p setSetMethod:@selector(setRequestDelay:) getMethod:@selector(requestDelay)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Data Offset"];
    [p setFormat:@"##0" upperLimit:30 lowerLimit:0 stepSize:2 units:@"ns"];
    [p setSetMethod:@selector(setDataOffset:) getMethod:@selector(dataOffset)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Time Out"];
    [p setFormat:@"##0" upperLimit:0xfff lowerLimit:0 stepSize:2 units:@"x50ns"];
    [p setSetMethod:@selector(setTimeOut:) getMethod:@selector(timeOut)];
    [a addObject:p];
	
    [a addObject:[ORHWWizParam boolParamWithName:@"Test Enabled"  setter:@selector(setTestEnabled:)  getter:@selector(testEnabled)]];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Text Clock"];
    [p setFormat:@"##0" upperLimit:3 lowerLimit:0 stepSize:0 units:@"index"];
    [p setSetMethod:@selector(setTestClock:) getMethod:@selector(testClock)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"Num Test Pulses"];
    [p setFormat:@"##0" upperLimit:31 lowerLimit:0 stepSize:0 units:@""];
    [p setSetMethod:@selector(setPulsesToGenerate:) getMethod:@selector(pulsesToGenerate)];
    [a addObject:p];
	
	
    return a;
}

- (NSArray*) wizardSelections
{
    NSMutableArray* a = [NSMutableArray array];
    [a addObject:[ORHWWizSelection itemAtLevel:kContainerLevel name:@"Crate" className:@"ORCamacCrateModel"]];
    ORHWWizSelection* s = [ORHWWizSelection itemAtLevel:kObjectLevel name:@"Station" className:@"ORTDC3377Model"];
    [a addObject:s];
    return a;
	
}
- (NSNumber*) extractParam:(NSString*)param from:(NSDictionary*)fileHeader forChannel:(int)aChannel
{
	NSDictionary* cardDictionary = [self findCardDictionaryInHeader:fileHeader];
    if([param isEqualToString:@"Data Shift"]) return [cardDictionary objectForKey:@"dataShift"];
    else if([param isEqualToString:@"Both Edges"]) return [cardDictionary objectForKey:@"bothEdges"];
    else if([param isEqualToString:@"Fera Mode"]) return [cardDictionary objectForKey:@"feraMode"];
    else if([param isEqualToString:@"MultiEvent Mode"]) return [cardDictionary objectForKey:@"multiEventBufferMode"];
    else if([param isEqualToString:@"Skip Header"]) return [cardDictionary objectForKey:@"skipHeader"];
    else if([param isEqualToString:@"Pulse Width"]) return [cardDictionary objectForKey:@"pulseWidth"];
    else if([param isEqualToString:@"Pulse Delay"]) return [cardDictionary objectForKey:@"pulseDelay"];
    else if([param isEqualToString:@"Clock Units"]) return [cardDictionary objectForKey:@"clockUnit"];
    else if([param isEqualToString:@"Pause Interval"]) return [cardDictionary objectForKey:@"pauseInterval"];
    else if([param isEqualToString:@"Max Hits"]) return [cardDictionary objectForKey:@"maxHitsPerTDC"];
    else if([param isEqualToString:@"Max Full Scale"]) return [cardDictionary objectForKey:@"maxFullScaleTime"];
    else if([param isEqualToString:@"Request Delay"]) return [cardDictionary objectForKey:@"requestDelay"];
    else if([param isEqualToString:@"Data Offset"]) return [cardDictionary objectForKey:@"dataOffset"];
    else if([param isEqualToString:@"Time Out"]) return [cardDictionary objectForKey:@"timeout"];
    else if([param isEqualToString:@"Test Enabled"]) return [cardDictionary objectForKey:@"testEnabled"];
    else if([param isEqualToString:@"Text Clock"]) return [cardDictionary objectForKey:@"testClock"];
    else if([param isEqualToString:@"Num Test Pulses"]) return [cardDictionary objectForKey:@"pulsesToGenerate"];
    else return nil;
}

- (NSMutableDictionary*) addParametersToDictionary:(NSMutableDictionary*)dictionary
{
    NSMutableDictionary* objDictionary = [super addParametersToDictionary:dictionary];
	
    [objDictionary setObject:[NSNumber numberWithBool:bothEdges] forKey:@"bothEdges"];
    [objDictionary setObject:[NSNumber numberWithBool:feraMode] forKey:@"feraMode"];
    [objDictionary setObject:[NSNumber numberWithBool:multiEventBufferMode] forKey:@"multiEventBufferMode"];
    [objDictionary setObject:[NSNumber numberWithBool:skipHeader] forKey:@"skipHeader"];
    [objDictionary setObject:[NSNumber numberWithBool:fastFeraMode] forKey:@"fastFeraMode"];
    [objDictionary setObject:[NSNumber numberWithBool:testEnabled] forKey:@"testEnabled"];
	
    [objDictionary setObject:[NSNumber numberWithInt:pulseWidth] forKey:@"pulseWidth"];
    [objDictionary setObject:[NSNumber numberWithInt:pulseDelay] forKey:@"pulseDelay"];
    [objDictionary setObject:[NSNumber numberWithInt:clockUnit] forKey:@"clockUnit"];
    [objDictionary setObject:[NSNumber numberWithInt:pauseInterval] forKey:@"pauseInterval"];
    [objDictionary setObject:[NSNumber numberWithInt:maxHitsPerTDC] forKey:@"maxHitsPerTDC"];
    [objDictionary setObject:[NSNumber numberWithInt:maxFullScaleTime] forKey:@"maxFullScaleTime"];
    [objDictionary setObject:[NSNumber numberWithInt:requestDelay] forKey:@"requestDelay"];
    [objDictionary setObject:[NSNumber numberWithInt:dataOffset] forKey:@"dataOffset"];
    [objDictionary setObject:[NSNumber numberWithInt:timeOut] forKey:@"timeout"];
    [objDictionary setObject:[NSNumber numberWithInt:testClock] forKey:@"testClock"];
    [objDictionary setObject:[NSNumber numberWithInt: pulsesToGenerate] forKey:@"pulsesToGenerate"];
    [objDictionary setObject:[NSNumber numberWithInt:dataShift] forKey:@"dataShift"];
	
    return objDictionary;
}

#pragma mark ¥¥¥Hardware Access
- (BOOL) loadTheMode
{
	cachedStation = [self stationNumber];
    unsigned short dummy;
    [[self adapter] camacShortNAF:cachedStation a:0 f:9 data:&dummy];  //clear all registers, etc...
	
    [[self adapter] camacShortNAF:cachedStation a:0 f:30 data:&dummy]; //select program mode
    if(controlMode > 0) {
        [[self adapter] camacShortNAF:cachedStation a:0 f:21+controlMode-1 data:&dummy]; //select program mode
	}
    [[self adapter] camacShortNAF:cachedStation a:0 f:25 data:&dummy]; //begin programing
    [ORTimer delay:.2];
    
    BOOL success = NO;
    NSTimeInterval t0 = [NSDate timeIntervalSinceReferenceDate];
    while ([NSDate timeIntervalSinceReferenceDate]- t0 < 1){
        unsigned short statusCC32 = [[self adapter] camacShortNAF:cachedStation a:0 f:13 data:&dummy]; //test the done flag
        if(isQbitSet(statusCC32)) {
            success = YES;
			[[self adapter] camacShortNAF:cachedStation a:0 f:9 data:&dummy]; //reset the PAL
            break;
        }
    }
    if(!success) return NO;
    
    return YES;
}

- (void) formatRegisters
{
	controlReg0 = 0;
    controlReg1 = 0;
    controlReg2 = 0;
    controlReg3 = 0;
    controlReg4 = 0;
    controlReg5 = 0;
	
    //common to all modes
    if(bothEdges)               controlReg0 |= 0x0001<<10;
    if(feraMode)                controlReg0 |= 0x0001<<11;
    if(multiEventBufferMode)    controlReg0 |= 0x0001<<12;
    if(skipHeader)              controlReg0 |= 0x0001<<13;
	
	
    //special cases
    switch(controlMode){
        case 0: //common stop single word
            controlReg0 |= (dataShift&0x3)<<8;
            
            controlReg1 |= pulseWidth&0xf;
            controlReg1 |= (pulseDelay&0xf)<<4;
			controlReg1 |= (clockUnit&0x3)<<8;
            controlReg1 |= (pauseInterval&0x3)<<10;
            if(fastFeraMode)controlReg1 |= 0x0001<<12;
            
            controlReg2 |= maxHitsPerTDC&0xf;
            controlReg2 |= (maxFullScaleTime&0xfff)<<4;
            
            controlReg3 |= requestDelay&0xf;
            controlReg3 |= (dataOffset&0x0fff)<<4;
			break;
			
        case 1: //common start single word
            controlReg0 |= (dataShift&0x3)<<8;
			
            controlReg1 |= (pauseInterval&0x3)<<10;
            if(fastFeraMode)controlReg1 |= 0x0001<<12;
			
            controlReg2 |= maxHitsPerTDC&0xf;
			
            controlReg3 |= requestDelay&0xf;
            controlReg3 |= (maxFullScaleTime&0xfff)<<4;
            
            controlReg4 |= (timeOut&0x03FF);
			
            controlReg5 |= (pulsesToGenerate&0x001F);
            controlReg5 |= (testClock&0x003)<<5;
            if(testEnabled)controlReg5 |= 0x0001<<8;
            
			break;
			
        case 2: //common stop double word
            controlReg1 |= pulseWidth&0xf;
            controlReg1 |= (pulseDelay&0xf)<<4;
            controlReg1 |= (clockUnit&0x3)<<8;
            controlReg1 |= (pauseInterval&0x3)<<10;
            if(fastFeraMode)controlReg1 |= 0x0001<<12;
			
            controlReg2 |= maxHitsPerTDC&0xf;
            controlReg2 |= (maxHitsPerTDC&0x0FFF)<<4;
			
            controlReg3 |= requestDelay&0xf;
			
			break;
			
        case 3: //common start double word
            controlReg1 |= (pauseInterval&0x3)<<10;
            if(fastFeraMode )controlReg1 |= 0x0001<<12;
            
            controlReg2 |= maxHitsPerTDC&0xf;
            
            controlReg3 |= requestDelay&0xf;
			
            controlReg4 |= timeOut&0x03FF;
			
            controlReg5 |= (pulsesToGenerate&0x001F);
            controlReg5 |= (testClock&0x003)<<5;
            if(testEnabled)controlReg5 |= 0x0001<<8;
			
			break;
    }
}
- (void) loadRegisters
{
	[self loadRegisters:NO];
}

- (void) loadRegisters:(BOOL)verbose
{
	cachedStation = [self stationNumber];
    [[self adapter] camacShortNAF:cachedStation a:0 f:17 data:&controlReg0];
	if(verbose)NSLog(@"Wrote 3377TDC Station %d control reg0: 0x%04x\n",cachedStation, controlReg0);
	
    [[self adapter] camacShortNAF:cachedStation a:1 f:17 data:&controlReg1];
	if(verbose)NSLog(@"Wrote 3377TDC Station %d control reg1: 0x%04x\n",cachedStation, controlReg1);
	
    [[self adapter] camacShortNAF:cachedStation a:2 f:17 data:&controlReg2];
	if(verbose)NSLog(@"Wrote 3377TDC Station %d control reg2: 0x%04x\n",cachedStation, controlReg2);
	
	[[self adapter] camacShortNAF:cachedStation a:3 f:17 data:&controlReg3];
	if(verbose)NSLog(@"Wrote 3377TDC Station %d control reg3: 0x%04x\n",cachedStation, controlReg3);
	
    if(controlMode == 1 || controlMode == 3){
        [[self adapter] camacShortNAF:cachedStation a:4 f:17 data:&controlReg4];
		if(verbose)NSLog(@"Wrote 3377TDC Station %d control reg4: 0x%04x\n",cachedStation, controlReg4);
		
        [[self adapter] camacShortNAF:cachedStation a:5 f:17 data:&controlReg5];
		if(verbose)NSLog(@"Wrote 3377TDC Station %d control reg5: 0x%04x\n",cachedStation, controlReg5);
    }
}

- (void) readBackRegisters:(BOOL)check
{
	cachedStation = [self stationNumber];
	//check the load
	unsigned short dummy;
	[[self adapter] camacShortNAF:cachedStation a:0 f:1 data:&dummy];
	dummy &= ~0xc000; //don't care about the top two bits.
	if(controlMode == 2)dummy &= ~0x0300;
	else if(controlMode == 3)dummy &= ~0x0300;
	if(check){
		if(dummy != controlReg0){
			[NSException raise:@"3377TDC reg0 mismatch" format:@"reg0 mismatch"];
			NSLogError(@"",@"TDC3377 Card Error",@"reg0 mismatch",nil);
		}
	}
	else NSLog(@"Read TDC3377 Station %d control reg0: 0x%04x\n",cachedStation, dummy);
	
	[[self adapter] camacShortNAF:cachedStation a:1 f:1 data:&dummy];
	dummy &= ~0xe000; //don't care about the top 3 bits.
	if(controlMode == 1) dummy &= ~0x03ff;
	else if(controlMode == 3) dummy &= ~0x03ff;
	if(check){
		if(dummy != controlReg1){
			[NSException raise:@"3377TDC reg1mismatch" format:@"reg1 mismatch"];
			NSLogError(@"",@"TDC3377 Card Error",@"reg1 mismatch",nil);
		}
	}
	else NSLog(@"Read TDC3377 Station %d control reg1: 0x%04x\n",cachedStation, dummy);
	
	[[self adapter] camacShortNAF:cachedStation a:2 f:1 data:&dummy];
	if(controlMode == 1) dummy &= ~0xfff0;
	if(controlMode == 3) dummy &= ~0xfff0;
	if(check){
		if(dummy != controlReg2){
			[NSException raise:@"3377TDC reg2 mismatch" format:@"reg2 mismatch"];
			NSLogError(@"",@"TDC3377 Card Error",@"reg2 mismatch",nil);
		}
	}
	else NSLog(@"Read TDC3377 Station %d control reg2: 0x%04x\n",cachedStation, dummy);
	
	[[self adapter] camacShortNAF:cachedStation a:3 f:1 data:&dummy];
	if(controlMode == 2) dummy &= ~0xfff00;
	else if(controlMode == 3) dummy &= ~0xfff0;
	if(check){
		if(dummy != controlReg3){
			[NSException raise:@"3377TDC reg3 mismatch" format:@"reg3 mismatch"];
			NSLogError(@"",@"TDC3377 Card Error",@"reg3 mismatch",nil);
		}
	}
	else NSLog(@"Read TDC3377 Station %d control reg3: 0x%04x\n",cachedStation, dummy);
	
    if(controlMode == 1 || controlMode == 3){
		[[self adapter] camacShortNAF:cachedStation a:4 f:1 data:&dummy];
		if(controlMode == 1) dummy &= ~0xfc00;
		else if(controlMode == 3) dummy &= ~0xfc00;
		if(check){
			if(dummy != controlReg4){
				[NSException raise:@"3377TDC reg4 mismatch" format:@"reg4 mismatch"];
				NSLogError(@"",@"TDC3377 Card Error",@"reg4 mismatch",nil);
			}
		}
		else NSLog(@"Read TDC3377 Station %d control reg4: 0x%04x\n",cachedStation, dummy);
		
		[[self adapter] camacShortNAF:cachedStation a:5 f:1 data:&dummy];
		if(controlMode == 1) {
			dummy &= ~0xfe00;
			dummy &= ~0x0080;
		}
		else if(controlMode == 3){
			dummy &= ~0xfc00;
			dummy &= ~0x0080;
		}
		if(check){
			if(dummy != controlReg5){
				[NSException raise:@"3377TDC reg5 mismatch" format:@"reg5 mismatch"];
				NSLogError(@"",@"TDC3377 Card Error",@"reg5 mismatch",nil);
			}
		}
		else NSLog(@"Read TDC3377 Station %d control reg5: 0x%04x\n",cachedStation, dummy);
	}
}

- (void) runTests
{
	if(!testsRunning){
		@try {
			[self setTestsRunning:YES];
			NSLog(@"Starting tests for 3377TDC station %d\n",[self stationNumber]);
			
			//clear the status text array
			int i;
			for(i=0;i<kNum3377TDCTests;i++){
				[testingStatus replaceObjectAtIndex:i withObject:@"--"];
			}
			
			//create the test suit
			if(testSuit)[testSuit release];
			testSuit = [[ORTestSuit alloc] init];
			if([self testingIsEnabled:0]) [testSuit addTest:[ORTest testSelector:@selector(testCamacInterface) tag:0]];
			if([self testingIsEnabled:1]) [testSuit addTest:[ORTest testSelector:@selector(fifoTest) tag:1]];
			if([self testingIsEnabled:2]) [testSuit addTest:[ORTest testSelector:@selector(patternTest) tag:2]];
			
			[testSuit runForObject:self];
		}
		@catch(NSException* localException) {
		}
	}
	else {
		NSLog(@"Tests for 3377TDC (station: %d) stopped manually\n",[self stationNumber]);
		[testSuit stopForObject:self];
	}
}

- (void) runningTest:(int)aTag status:(NSString*)theStatus
{
	[testingStatus replaceObjectAtIndex:aTag withObject:theStatus];
    [[NSNotificationCenter defaultCenter] postNotificationName:ORTDC3377ModelTestingStatusChanged object:self];
}

- (void) checkEvent
{
	unsigned short dummy;
	unsigned short statusWord = [[self adapter] camacShortNAF:[self stationNumber] a:2 f:27 data:&dummy];
	if(isQbitSet(statusWord))NSLog(@"event ready\n");
	else NSLog(@"NO event\n");
}

- (void) enableAcq
{
	unsigned short dummy;
	[[self adapter] camacShortNAF:[self stationNumber] a:0 f:26 data:&dummy]; //enable the LAM
	[[self adapter] camacShortNAF:[self stationNumber] a:1 f:26 data:&dummy]; //enable acq mode
	[[self adapter] camacShortNAF:[self stationNumber] a:0 f:9 data:&dummy]; //clear buffer
	
}

#pragma mark ¥¥¥DataTaker
- (void) setDataIds:(id)assigner
{
    dataId = [assigner assignDataIds:kLongForm];
}

- (void) syncDataIdsWith:(id)anotherCard
{
    [self setDataId:[anotherCard dataId]];
}

- (NSDictionary*) dataRecordDescription
{
    NSMutableDictionary* dataDictionary = [NSMutableDictionary dictionary];
    NSDictionary* aDictionary = [NSDictionary dictionaryWithObjectsAndKeys:
								 @"ORTDC3377DecoderForTDC",           @"decoder",
								 [NSNumber numberWithLong:dataId],    @"dataId",
								 [NSNumber numberWithBool:YES],       @"variable",
								 [NSNumber numberWithLong:-1],        @"length",
								 nil];
    [dataDictionary setObject:aDictionary forKey:@"tdc"];
    return dataDictionary;
}

- (void) appendDataDescription:(ORDataPacket*)aDataPacket userInfo:(NSDictionary*)userInfo
{
    //----------------------------------------------------------------------------------------
    // first add our description to the data description
    [aDataPacket addDataDescriptionItem:[self dataRecordDescription] forKey:@"ORTDC3377"];
}

- (void) reset
{
}

- (void) runTaskStarted:(ORDataPacket*)aDataPacket userInfo:(NSDictionary*)userInfo
{
	
    if(![self adapter]){
		[NSException raise:@"Not Connected" format:@"You must connect to a PCI-CAMAC Controller (i.e. a CC32)."];
    }
	
    //----------------------------------------------------------------------------------------
    // first add our description to the data description
    
    [aDataPacket addDataDescriptionItem:[self dataRecordDescription] forKey:@"ORTDC3377Model"];    
    
    //----------------------------------------------------------------------------------------
    controller = [[self adapter] controller]; //cache the controller for alittle bit more speed.
	long version = 1;
    unChangingDataPart   = version<<25 | (([self crateNumber]&0xf)<<21) | (([self stationNumber]& 0x0000001f)<<16); //doesn't change so do it here.
	
	cachedStation = [self stationNumber];
    [self clearExceptionCount];
    if([self loadTheMode]){
        [self formatRegisters];
        [self loadRegisters];
		//check the load
		//[self readBackRegisters:YES];
    }
	firstTime = YES;
}

//**************************************************************************************
// Function:	TakeData
// Description: Read data from a card
//**************************************************************************************

- (void) takeData:(ORDataPacket*)aDataPacket userInfo:(NSDictionary*)userInfo
{
    unsigned short dummy;
    unsigned short statusWord;
    NSString* errorLocation = @"";
	union {
		NSTimeInterval asTimeInterval;
		unsigned long asLongs[2];
	}theTimeRef;
	
	
    @try {
        
		if(!firstTime){
            //test if data ready to be read out
            statusWord = [controller camacShortNAF:cachedStation a:2 f:27 data:&dummy];
            if(isQbitSet(statusWord)){
				//data is ready to be readout
				
				//grab the event time as reference from Jan 1, 2004.
				theTimeRef.asTimeInterval = [NSDate timeIntervalSinceReferenceDate];
				
				//read the events, Q Bit will be set as long as data is valid
				NSMutableData* eventBuffer = nil;
				BOOL printedHeaderErrorOnce = NO;
				unsigned short dataWordCount = 0;
				unsigned short dataWord;
				while(isQbitSet([controller camacShortNAF:cachedStation a:0 f:0 data:&dataWord])){
					if(dataWord & 0x8000) {	//it's a header word
						if(dataWordCount!=0){
							//ship a pending event
							[self shipEvent:aDataPacket data:eventBuffer numWords:dataWordCount];
						}
						//start an event
						[eventBuffer release];
						eventBuffer = [[NSMutableData allocWithZone:nil] initWithCapacity:1024*sizeof(long)];
						dataWordCount = 0;
						
						[eventBuffer appendBytes:&dataId length:sizeof(long)];               //we'll add in the length when we know it.
						[eventBuffer appendBytes:&unChangingDataPart length:sizeof(long)];   //add in the crate, card info
						unsigned long highPart = theTimeRef.asLongs[1];
						unsigned long lowPart  = theTimeRef.asLongs[0];
						[eventBuffer appendBytes:&highPart length:sizeof(long)];  
						[eventBuffer appendBytes:&lowPart  length:sizeof(long)];  
						[eventBuffer appendBytes:&dataWord length:sizeof(short)];			//add in the header word
					}
					else {
						if(eventBuffer){
							[eventBuffer appendBytes:&dataWord length:sizeof(short)];
							dataWordCount++;
						}
						else {
							if(!printedHeaderErrorOnce){
								NSLogError(@"",@"TDC3377 Card Error",@"Missing Header--Data Flushed",nil);
								printedHeaderErrorOnce = YES;
							}
						}
					}
				}
				
				if(eventBuffer){
					//ship the last event
					[self shipEvent:aDataPacket data:eventBuffer numWords:dataWordCount];
					[eventBuffer release];
					eventBuffer = nil;
				}
			}
		}
		else {
			[self enableAcq];
			firstTime = NO;
		}
	}
	@catch(NSException* localException) {
		NSLogError(@"",@"TDC3377 Card Error",errorLocation,nil);
		[self incExceptionCount];
		[localException raise];
	}
	
}

- (void) shipEvent:(ORDataPacket*)aDataPacket data:(NSMutableData*)eventBuffer numWords:(NSUInteger)dataWordCount
{
	if(dataWordCount){
		if(eventBuffer){
			//pad to a longword boundary
			if([eventBuffer length]%sizeof(long)){
				short dataWord = 0x0;
				[eventBuffer appendBytes:&dataWord length:sizeof(short)];
			}
			unsigned long* ptr = (unsigned long*)[eventBuffer mutableBytes];
			*ptr |= (([eventBuffer length]/sizeof(long)) & kLongFormLengthMask);
			
			ptr++;
			*ptr |= dataWordCount;
			
			[aDataPacket addData:eventBuffer];          //ship the data
		}
		else {
			NSLogError(@"",@"TDC3377 Card Error",@"Missing Header--Data Flushed",nil);
		}
	}
	else {
		NSLogError(@"",@"TDC3377 Card Error",@"Header with No Data--Header Ignored",nil);
	}
}

- (void) runTaskStopped:(ORDataPacket*)aDataPacket userInfo:(NSDictionary*)userInfo
{
}

@end

@implementation ORTDC3377Model (private)
- (void) testCamacInterface
{
	int testNumber = 0;
	if(!testsRunning){
		[self runningTest:testNumber status:@"stopped"];
		return;
	}
	
	@try {
		unsigned short savedControlMode = controlMode;
		controlMode = 0;
		[self loadTheMode];
		cachedStation = [self stationNumber];
		id theAdapter = [self adapter];	
		int i;
		int count = 0;
		for(i=0;i<0xffff;i++){
			unsigned short dummy = i;
			[theAdapter camacShortNAF:cachedStation a:3 f:17 data:&dummy];
			[theAdapter camacShortNAF:cachedStation a:3 f:1 data:&dummy];
			if(dummy != i)count++;
		}
		if(count){
			NSLogColor([NSColor redColor],@"CAMAC interface test for 3377TDC station %d FAILED. Failure count: %d\n",cachedStation,count);
			id result = [[NSAttributedString alloc] initWithString:@"FAILED" 
														attributes:[NSDictionary dictionaryWithObject:[NSColor failedColor] forKey:NSForegroundColorAttributeName]];
			[self runningTest:testNumber status:result];
			[result release];
		}
		else {
			NSLog(@"CAMAC interface test for 3377TDC station %d Passed.\n",cachedStation);
			id result = [[NSAttributedString alloc] initWithString:@"Passed" 
														attributes:[NSDictionary dictionaryWithObject: [NSColor passedColor] forKey:NSForegroundColorAttributeName]];
			[self runningTest:testNumber status:result];
			[result release];
		}
		controlMode = savedControlMode;
		[self loadTheMode];
		
		[testSuit runForObject:self];
	}
	@catch(NSException* localException) {
		NSLog(@"CAMAC interface test for 3377TDC station %d FAILED due to exception.\n",cachedStation);	
		[localException raise];
	}
	
}


- (void) fifoTest
{
	int testNumber = 1;
	if(!testsRunning){
		[self runningTest:testNumber status:@"stopped"];
		return;
	}
	@try {
		unsigned short statusWord;
		unsigned short savedControlMode = controlMode;
		[self setControlMode:1];
		[self loadTheMode];
		cachedStation = [self stationNumber];
		
		unsigned short dummy;
		unsigned short errorCount = 0;
		unsigned short eventCount = 0;
		[[self adapter] camacShortNAF:cachedStation a:0 f:24 data:&dummy]; //disable the LAM
		[[self adapter] camacShortNAF:cachedStation a:0 f:9 data:&dummy]; //clear all data
		unsigned short numEvents = 2;
		unsigned short event;
		unsigned short chan;
		unsigned short eventValue;
		for(event=0;event<numEvents;event++){
			unsigned short chan;
			for(chan=0;chan<32;chan++){
				eventValue = chan;
				if(chan < 31)[[self adapter] camacShortNAF:cachedStation a:0 f:16 data:&eventValue];
				else [[self adapter] camacShortNAF:cachedStation a:1 f:16 data:&eventValue]; //write end of event tag
				
			}
		}
		
		for(event=0;event<numEvents;event++){
			for(chan=0;chan<32;chan++){
				unsigned short dataWord;
				statusWord = [[self adapter] camacShortNAF:cachedStation a:0 f:0 data:&dataWord];
				if(dataWord != chan){
					errorCount++;
				}
				if(!isQbitSet(statusWord)) {
					eventCount++;					
					break;
				}
			}
		}
		if(errorCount)  {
			NSLogColor([NSColor redColor],@"CAMAC fifo load/unload test for 3377TDC station %d FAILED. <%d> mismatches\n",cachedStation,errorCount);
			id result = [[NSAttributedString alloc] initWithString:@"FAILED" 
														attributes:[NSDictionary dictionaryWithObject:[NSColor failedColor] forKey:NSForegroundColorAttributeName]];
			[self runningTest:testNumber status:result];
		}
		else if(eventCount != numEvents){
			NSLogColor([NSColor redColor],@"CAMAC fifo load/unload test for 3377TDC station %d FAILED. <%d/%d> events readout\n",cachedStation,eventCount,numEvents);
			id result = [[NSAttributedString alloc] initWithString:@"FAILED" 
														attributes:[NSDictionary dictionaryWithObject:[NSColor failedColor] forKey:NSForegroundColorAttributeName]];
			[self runningTest:testNumber status:result];
		}
		else {
			NSLog(@"CAMAC fifo load test for 3377TDC station %d Passed.\n",cachedStation);
			id result = [[NSAttributedString alloc] initWithString:@"Passed" 
														attributes:[NSDictionary dictionaryWithObject:[NSColor passedColor] forKey:NSForegroundColorAttributeName]];
			[self runningTest:testNumber status:result];
		}
		controlMode = savedControlMode;
		[self loadTheMode];
		
		[testSuit runForObject:self];
		
	}
	@catch(NSException* localException) {
		NSLog(@"CAMAC fifo load/unload test test for 3377TDC station %d FAILED due to exception.\n",cachedStation);	
		[localException raise];
	}
}


- (void) patternTest
{
	int testNumber = 2;
	if(!testsRunning){
		[self runningTest:testNumber status:@"stopped"];
		return;
	}
	
	@try {
		if(testEnabled){
			unsigned short statusWord;
			unsigned short savedControlMode = controlMode;
			[self setControlMode:1];
			[self loadTheMode];
			[self loadRegisters];
			cachedStation = [self stationNumber];
			unsigned short dummy;
			unsigned short wordCount = 0;
			unsigned short eventCount = 0;
			unsigned short breakoutCount = 0;
			[[self adapter] camacShortNAF:cachedStation a:0 f:26 data:&dummy]; //Enable LAM
			[[self adapter] camacShortNAF:cachedStation a:1 f:26 data:&dummy]; //Enable Acq
			[[self adapter] camacShortNAF:cachedStation a:0 f:25 data:&dummy]; //start test cycle
			[ORTimer delay:.1];
			while(1) {
				statusWord = [[self adapter] camacShortNAF:cachedStation a:2 f:27 data:&dummy]; //data Ready
				if(isQbitSet(statusWord)){
					while(1){
						statusWord = [[self adapter] camacShortNAF:cachedStation a:0 f:0 data:&dummy]; //read data
						if(isQbitSet(statusWord)){
							if(dummy & 0x8000)eventCount++;
							else wordCount++;
						}
						else break;
						breakoutCount++;
					}
				}
				else break;
				breakoutCount++;
				if(breakoutCount>1000)break;
			}
			
			if(eventCount == 0)  {
				NSLogColor([NSColor redColor],@"CAMAC pattern test for 3377TDC station %d FAILED.\n",cachedStation);
				id result = [[NSAttributedString alloc] initWithString:@"FAILED" 
															attributes:[NSDictionary dictionaryWithObject:[NSColor failedColor] forKey:NSForegroundColorAttributeName]];
				[self runningTest:testNumber status:result];
			}
			else {
				NSLog(@"CAMAC pattern test for 3377TDC station %d Passed.\n",cachedStation);
				id result = [[NSAttributedString alloc] initWithString:@"Passed" 
															attributes:[NSDictionary dictionaryWithObject:[NSColor passedColor] forKey:NSForegroundColorAttributeName]];
				[self runningTest:testNumber status:result];
			}
			controlMode = savedControlMode;
			[self loadTheMode];
		}
		else {
			NSLog(@"CAMAC pattern test for 3377TDC station %d not enabled.\n",cachedStation);
			[self runningTest:testNumber status:@"Not Enabled"];
		}
		
		[testSuit runForObject:self];
		
	}
	@catch(NSException* localException) {
		NSLog(@"CAMAC fifo load/unload test test for 3377TDC station %d FAILED due to exception.\n",cachedStation);	
		[localException raise];
	}
}


@end

