//--------------------------------------------------------
// ORAcqirisDC440Model
// Created by Mark A. Howe on Fri Jun 22 2007
// Code partially generated by the OrcaCodeWizard. Written by Mark A. Howe.
// Copyright (c) 2007 CENPA, University of Washington. All rights reserved.
//-----------------------------------------------------------
//This program was prepared for the Regents of the University of 
//Washington at the Center for Experimental Nuclear Physics and 
//Astrophysics (CENPA) sponsored in part by the United States 
//Department of Energy (DOE) under Grant #DE-FG03-97ER41020/A000. 
//The University has certain rights in the program pursuant to 
//the contract and the program should not be copied or distributed 
//outside your organization.  The DOE and the University of 
//Washington reserve all rights in the program. Neither the authors,
//University of Washington, or U.S. Government make any warranty, 
//express or implied, or assume any liability or responsibility 
//for the use of this software.
//-------------------------------------------------------------

#pragma mark ***Imported Files

#import "ORAcqirisDC440Model.h"
#import "ORcPCIcpuModel.h"
#import "ORDataTypeAssigner.h"
#import "ORRateGroup.h"
#import "ORHWWizParam.h"
#import "ORHWWizSelection.h"
#import "SBC_Link.h"

#pragma mark 본벤xternal Strings
NSString* ORAcqirisDC440ModelEnableMaskChanged		 = @"ORAcqirisDC440ModelEnableMaskChanged";
NSString* ORAcqirisDC440ReadContinouslyChanged		 = @"ORAcqirisDC440ReadContinouslyChanged";
NSString* ORAcqirisDC440TriggerSlopeChanged			 = @"ORAcqirisDC440TriggerSlopeChanged";
NSString* ORAcqirisDC440TriggerLevelChanged			 = @"ORAcqirisDC440TriggerLevelChanged";
NSString* ORAcqirisDC440TriggerCouplingChanged		 = @"ORAcqirisDC440TriggerCouplingChanged";
NSString* ORAcqirisDC440TriggerSourceChanged		 = @"ORAcqirisDC440TriggerSourceChanged";
NSString* ORAcqirisDC440CouplingChanged				 = @"ORAcqirisDC440CouplingChanged";
NSString* ORAcqirisDC440VerticalOffsetChanged		 = @"ORAcqirisDC440VerticalOffsetChanged";
NSString* ORAcqirisDC440FullScaleChanged			 = @"ORAcqirisDC440FullScaleChanged";
NSString* ORAcqirisDC440DelayTimeChanged			 = @"ORAcqirisDC440DelayTimeChanged";
NSString* ORAcqirisDC440SampleIntervalChanged		 = @"ORAcqirisDC440SampleIntervalChanged";
NSString* ORAcqirisDC440NumberSamplesChanged		 = @"ORAcqirisDC440NumberSamplesChanged";
NSString* ORAcqirisDC440DataChanged					 = @"ORAcqirisDC440DataChanged";
NSString* ORAcqirisDC440RateGroupChangedNotification = @"ORAcqirisDC440RateGroupChangedNotification";
NSString* ORAcqirisDC440SamplingWaveforms			 = @"ORAcqirisDC440SamplingWaveforms";
NSString* ORAcqirisDC440SettingsLock				 = @"ORAcqirisDC440SettingsLock";
NSString* ORAcqirisDC440BoardIDChanged				 = @"ORAcqirisDC440BoardIDChanged";

static NSString* trigggerSlopeNames[6] = {
@"Positive",
@"Negative",
@"Out of Window",
@"Into Window",
@"HF Divide",
@"SpikeStretcher"
};

static NSString* verticalCouplingNames[5] = {
@"Ground",
@"DC, 1M Ohm",
@"AC, 1M Ohm",
@"DC, 50 Ohm",
@"AC, 50 Ohm"
};

static float DC440_fullscale[8] = {0.05, 0.10, 0.20, 0.50, 1.0, 2.0, 5.0, 10.0}; 


@implementation ORAcqirisDC440Model
- (id) init
{
	self = [super init];
    [[self undoManager] disableUndoRegistration];
	[self setSampleRateGroup:[[[ORRateGroup alloc] initGroup:2 groupTag:0] autorelease]];
	[sampleRateGroup setIntegrationTime:5];
    [[self undoManager] enableUndoRegistration];
	return self;
}

- (void) dealloc
{
	[triggerLevels release];
    [sampleRateGroup quit];
    [sampleRateGroup release];
	[super dealloc];
}

- (void) setUpImage
{
	[self setImage:[NSImage imageNamed:@"AcqirisDC440"]];
}

- (void) makeMainController
{
	[self linkToController:@"ORAcqirisDC440Controller"];
}

- (NSString*) helpURL
{
	return @"cPCI/DC440.html";
}

#pragma mark 본베ccessors
- (BOOL) samplingWaveforms
{
	return samplingWaveforms;
}

- (void) setSamplingWaveforms:(BOOL)state
{
    samplingWaveforms = state;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440SamplingWaveforms object:self];
}

- (void) setEnableMaskBit:(int)bit withValue:(BOOL)aValue
{
	unsigned char aMask = enableMask;
	if(aValue)aMask |= (1<<bit);
	else aMask &= ~(1<<bit);
	[self setEnableMask:aMask];	
}

- (unsigned short) enableMask
{
    return enableMask;
}

- (void) setEnableMask:(unsigned short)aEnableMask
{
    [[[self undoManager] prepareWithInvocationTarget:self] setEnableMask:enableMask];
    
    enableMask = aEnableMask;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440ModelEnableMaskChanged object:self];
}

- (void) setIntegrationTime:(double)newIntegrationTime
{
	//we this here so we have undo/redo on the rate object.
    [[[self undoManager] prepareWithInvocationTarget:self] setIntegrationTime:[sampleRateGroup integrationTime]];
	[sampleRateGroup setIntegrationTime:newIntegrationTime];
}

- (id) rateObject:(int)channel
{
	return [sampleRateGroup rateObject:channel];
}

- (ORRateGroup*) sampleRateGroup
{
	return sampleRateGroup;
}
- (void) setSampleRateGroup:(ORRateGroup*)newSampleRateGroup
{
	[newSampleRateGroup retain];
	[sampleRateGroup release];
	sampleRateGroup = newSampleRateGroup;
	
    [[NSNotificationCenter defaultCenter]
	 postNotificationName:ORAcqirisDC440RateGroupChangedNotification
	 object:self];    
}

- (BOOL) readContinously
{
    return readContinously;
}

- (void) setReadContinously:(BOOL)aReadContinously
{
    [[[self undoManager] prepareWithInvocationTarget:self] setReadContinously:readContinously];
    
    readContinously = aReadContinously;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440ReadContinouslyChanged object:self];
}


- (int) triggerSlope
{
    return triggerSlope;
}

- (void) setTriggerSlope:(int)aTriggerSlope
{
    [[[self undoManager] prepareWithInvocationTarget:self] setTriggerSlope:triggerSlope];
    
    triggerSlope = aTriggerSlope;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440TriggerSlopeChanged object:self];
}

- (double) triggerLevel:(int)index
{
    return [[triggerLevels objectAtIndex:index] doubleValue];
}

- (void) setTriggerLevel:(int)index withValue:(double)aTriggerLevel
{
	if(!triggerLevels){
		triggerLevels = [[NSMutableArray arrayWithObjects:[NSNumber numberWithDouble:0],[NSNumber numberWithDouble:1],nil] retain];
	}
    [[[self undoManager] prepareWithInvocationTarget:self] setTriggerLevel:index withValue:[[triggerLevels objectAtIndex:index] doubleValue]];
    
    [triggerLevels replaceObjectAtIndex:index withObject:[NSNumber numberWithDouble:aTriggerLevel]];
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440TriggerLevelChanged object:self];
}

- (int) triggerCoupling
{
    return triggerCoupling;
}

- (void) setTriggerCoupling:(int)aTriggerCoupling
{
    [[[self undoManager] prepareWithInvocationTarget:self] setTriggerCoupling:triggerCoupling];
    triggerCoupling = aTriggerCoupling;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440TriggerCouplingChanged object:self];
}

- (int) triggerSource
{
    return triggerSource;
}

- (void) setTriggerSource:(int)aTriggerSource
{
    [[[self undoManager] prepareWithInvocationTarget:self] setTriggerSource:triggerSource];
    
    triggerSource = aTriggerSource;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440TriggerSourceChanged object:self];
}

- (int) coupling
{
    return coupling;
}

- (void) setCoupling:(int)aCoupling
{
    [[[self undoManager] prepareWithInvocationTarget:self] setCoupling:coupling];
    
    coupling = aCoupling;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440CouplingChanged object:self];
}

- (double) verticalOffset
{
    return verticalOffset;
}

- (void) setVerticalOffset:(double)aOffset
{
    [[[self undoManager] prepareWithInvocationTarget:self] setVerticalOffset:verticalOffset];
    
    verticalOffset = aOffset;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440VerticalOffsetChanged object:self];
}

- (int) fullScale
{
    return fullScale;
}

- (void) setFullScaleFromValue:(double)aFullScale
{
	int closestIndex = 0;
	int i;
	double smallestDiff = 9999.0;
	for(i=0;i<8;i++){
		double diff = fabs(aFullScale - DC440_fullscale[i]);
		if(diff < smallestDiff){
			closestIndex = i;
			smallestDiff = diff;
		}
	}
	[self setFullScale:closestIndex];
}

- (void) setFullScale:(int)aFullScale
{
	if(aFullScale <= 0)aFullScale = 0;
	else if(aFullScale>9)aFullScale = 9;
    [[[self undoManager] prepareWithInvocationTarget:self] setFullScale:fullScale];
    
    fullScale = aFullScale;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440FullScaleChanged object:self];
}
- (double) delayTime
{
    return delayTime;
}

- (void) setDelayTime:(double)aDelayTime
{
    [[[self undoManager] prepareWithInvocationTarget:self] setDelayTime:delayTime];
    
    delayTime = aDelayTime;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440DelayTimeChanged object:self];
}


- (double) sampleInterval
{
    return sampleInterval;
}

- (void) setSampleInterval:(double)aSampleInterval
{
    [[[self undoManager] prepareWithInvocationTarget:self] setSampleInterval:sampleInterval];
    
    sampleInterval = aSampleInterval;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440SampleIntervalChanged object:self];
}

- (uint32_t) numberSamples
{
    return numberSamples;
}

- (void) setNumberSamples:(uint32_t)aNumberSamples
{
    [[[self undoManager] prepareWithInvocationTarget:self] setNumberSamples:numberSamples];
    
    numberSamples = aNumberSamples;
	
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440NumberSamplesChanged object:self];
}

- (uint32_t) dataId { return dataId; }
- (void) setDataId: (uint32_t) DataId
{
    dataId = DataId;
}

- (void) assignBoardID
{
	[self probe:NO];
    [[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440BoardIDChanged object:self];

	NSLog(@"Acqiris DC440 %d %d assigned boardID %d\n",[self stationNumber],[self baseAddress], boardID);
}

- (uint32_t) boardID
{
	return boardID;
}

- (uint32_t) probe:(BOOL) verbose
{
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetSerialNumbers cmdArgs:nil];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		uint32_t n = (uint32_t)[args count]/3;
		if(verbose){
			NSLog(@"found %d DC440 card%@ Serial #%@:\n",n,n>1?@"s.":@".",n>1?@"s are":@" is");
		}
		int i;
		for(i=0;i<n;i++){
			NSString* name = [args objectAtIndex:(i*3)+2];
			uint32_t serialNumber = [[args objectAtIndex:(i*3)+1] intValue];
			if(serialNumber == [self baseAddress]){
				boardID = [[args objectAtIndex:(i*3)] intValue];
				if(verbose){
					NSLog(@"(%@)  %d: %d %d \n",name,i,boardID, serialNumber);
				}
			}
		}
	}
	return response.status;
}


- (void) connected
{
	[self assignBoardID];
	if([[self adapter] initAfterConnect]){
		[self initBoard];
	}
}

- (uint32_t) startAcquisition
{
	return [self doCommand:kAcqiris_StartRun cmdArgs:[NSString stringWithFormat:@"%u",boardID]];
}

- (uint32_t) stopAcquisition
{
	return [self doCommand:kAcqiris_StopRun cmdArgs:[NSString stringWithFormat:@"%u",boardID]];
}

- (BOOL) dataAvailable
{
	return [self doCommand:kAcqiris_DataAvailable cmdArgs:[NSString stringWithFormat:@"%u",boardID]];
}

- (uint32_t) setConfigureMemory
{
	NSString* args = [NSString stringWithFormat:@"%u,%d,1",boardID,numberSamples];
	int32_t status =  [self doSetXXXCommand:kAcqiris_SetConfigMemory cmdArgs:args];
	if(status)NSLog(@"config Memory status: %@\n",[self decodeError:status]);
	return status;
}

- (uint32_t) setConfigureVertical:(int)chan
{
	
	NSString* args = [NSString stringWithFormat:@"%u,%d,%G,%G,%d,0",boardID,chan,DC440_fullscale[fullScale],verticalOffset,coupling];
	int32_t status = [self doSetXXXCommand:kAcqiris_SetConfigVertical cmdArgs:args];
	if(status)NSLog(@"config Vertical status (%d): %@\n",chan,[self decodeError:status]);
	return status;
}

- (uint32_t) setConfigureHorizontal
{
	NSString* args = [NSString stringWithFormat:@"%u,%G,%G",boardID,sampleInterval/1000000.0,delayTime/1000000.0];
	int32_t status = [self doSetXXXCommand:kAcqiris_SetConfigHorizontal cmdArgs:args];
	if(status)NSLog(@"config Horizontal status: %@\n",[self decodeError:status]);
	return status;
}

- (uint32_t) setConfigureTrigClass
{
	uint32_t sourcePattern = 0x00000000;
	switch(triggerSource){
		case 0: sourcePattern = 0x80000000; break;
		case 1: sourcePattern = 0x00000001; break;
		case 2: sourcePattern = 0x00000002; break;
	}
	NSString* args = [NSString stringWithFormat:@"%u,0,%d,0,0,0,0",boardID,sourcePattern];
	int32_t status = [self doSetXXXCommand:kAcqiris_SetConfigTrigClass cmdArgs:args];
	if(status)NSLog(@"config Trig Class status: %@\n",[self decodeError:status]);
	return status;
}

- (uint32_t) setConfigureTrigSource
{
	int32_t trig;
	if(triggerSource==0)trig = -1;
	else trig = triggerSource;
	
	NSString* args = [NSString stringWithFormat:@"%u,%d,%d,%d,%G,%G",boardID,trig,triggerCoupling,triggerSlope,[self triggerLevel:0],[self triggerLevel:1]];
	int32_t status = [self doSetXXXCommand:kAcqiris_SetConfigTrigSource cmdArgs:args];
	if(status)NSLog(@"config Trig Source status: %@\n",[self decodeError:status]);
	return status;
}

- (id) decodeError:(int32_t)status
{
	switch(status){
		case 1073368576: return @"Value Adapted";
		default:		 return [NSNumber numberWithLong:status];
	}
	return @"Programming Error if you get here";
}

- (uint32_t) getHorizontal
{
	NSString* args = [NSString stringWithFormat:@"%u",boardID];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetHorizontal cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		[[self undoManager] disableUndoRegistration];
		[self setSampleInterval:[[args objectAtIndex:0] doubleValue]*1000000.0];
		[self setDelayTime:[[args objectAtIndex:1] doubleValue]*1000000.0];
		[[self undoManager] enableUndoRegistration];
	}
	return response.status;
}

- (uint32_t) getVertical
{
	int32_t trig;
	if(triggerSource==0)trig = -1;
	else trig = triggerSource;
	NSString* args = [NSString stringWithFormat:@"%u,%d",boardID,trig];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetVertical cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		[[self undoManager] disableUndoRegistration];
		[self setFullScaleFromValue:[[args objectAtIndex:0] doubleValue]];
		[self setVerticalOffset:[[args objectAtIndex:1] doubleValue]];
		[self setCoupling:[[args objectAtIndex:2] doubleValue]];
		//don't set bandwidth at this time....
		[[self undoManager] enableUndoRegistration];
	}
	return response.status;
}

- (uint32_t) getMemory
{
	NSString* args = [NSString stringWithFormat:@"%u",boardID];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetMemory cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		[[self undoManager] disableUndoRegistration];
		[self setNumberSamples:[[args objectAtIndex:0] intValue]];
		[[self undoManager] enableUndoRegistration];
	}
	return response.status;
}

- (uint32_t) getNumberChannels
{
	NSString* args = [NSString stringWithFormat:@"%u",boardID];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetNbrChannels cmdArgs:args];
	NSLog(@"get NbrChannels status:%d --- %s\n",response.status,response.responseBuffer);
	return response.status;
}

- (uint32_t) getTriggerSource
{
	int32_t trig;
	if(triggerSource==0)trig = -1;
	else trig = triggerSource;
	NSString* args = [NSString stringWithFormat:@"%u,%d",boardID,trig];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetTrigSource cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		[[self undoManager] disableUndoRegistration];
		[self setTriggerCoupling:[[args objectAtIndex:0] intValue]];
		[self setTriggerSlope:[[args objectAtIndex:1] intValue]];
		[self setTriggerLevel:0 withValue:[[args objectAtIndex:2] doubleValue]];
		[self setTriggerLevel:1 withValue:[[args objectAtIndex:3] doubleValue]];
		[[self undoManager] enableUndoRegistration];
	}
	return response.status;
}

- (uint32_t) getTriggerClass
{
	NSString* args = [NSString stringWithFormat:@"%u",boardID];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetTrigClass cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		[[self undoManager] disableUndoRegistration];
		int trig = [[args objectAtIndex:1] intValue];
		if(trig & 0x1)				[self setTriggerSource:1];
		else if(trig & 0x2)			[self setTriggerSource:2];
		else if(trig & 0x80000000)	[self setTriggerSource:0];
		
		[[self undoManager] enableUndoRegistration];
	}
	return response.status;
}


- (void) reportAll
{
	NSLog(@"Parmeters for Acqiris (slot %d)\n",[self stationNumber]);
	[self reportTriggerSource];
	[self reportHorizontal];
	[self reportMemory];
	[self reportVertical];
	[self reportTriggerClass];
}

- (uint32_t) reportTriggerSource
{
	int32_t trig;
	if(triggerSource==0)trig = -1;
	else trig = triggerSource;
	NSString* args = [NSString stringWithFormat:@"%u,%d",boardID,trig];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetTrigSource cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		NSLog(@"--Vertical Settings--\n");
		NSLog(@"Trigger Coupling: %@\n",[args objectAtIndex:0]);
		NSLog(@"Trigger Slope   : %@\n",trigggerSlopeNames[[[args objectAtIndex:1] intValue]]);
		NSLog(@"Trigger Level1  : %@ %@\n",[args objectAtIndex:2],triggerSource==0?@"mV":@"%");
		NSLog(@"Trigger Level2  : %@ %@\n",[args objectAtIndex:3],triggerSource==0?@"mV":@"%");
	}
	return response.status;
}

- (uint32_t) reportTriggerClass
{
	NSString* args = [NSString stringWithFormat:@"%u",boardID];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetTrigClass cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		NSLog(@"--Trigger Class--\n");
		if([[args objectAtIndex:0] intValue])NSLog(@"TV Trigger\n");
		else NSLog(@"Edge Trigger\n");
		uint32_t trig = [[args objectAtIndex:1] intValue];
		if(trig & 0x1)      NSLog(@"Channel 1\n");
		else if(trig & 0x2) NSLog(@"Channel 2\n");
		else if(trig & 0x80000000) NSLog(@"External\n");
	}
	return response.status;
}


- (uint32_t) reportHorizontal
{
	NSString* args = [NSString stringWithFormat:@"%u",boardID];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetHorizontal cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		NSLog(@"--Horizontal Settings--\n");
		NSLog(@"Sample Interval: %@\n",[args objectAtIndex:0]);
		NSLog(@"Delay Time: %@\n",[args objectAtIndex:1]);
	}
	return response.status;
}

- (uint32_t) reportVertical
{
	int32_t trig;
	if(triggerSource==0)trig = -1;
	else trig = triggerSource;
	NSString* args = [NSString stringWithFormat:@"%u,%d",boardID,trig];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetVertical cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		NSLog(@"--Vertical Settings--\n");
		NSLog(@"Full Scale : %@\n",[args objectAtIndex:0]);
		NSLog(@"Vert Offset: %@\n",[args objectAtIndex:1]);
		NSLog(@"Coupling   : %@\n",verticalCouplingNames[[[args objectAtIndex:2] intValue]]);
	}
	return response.status;
}

- (uint32_t) reportMemory
{
	NSString* args = [NSString stringWithFormat:@"%u",boardID];
	Acquiris_GetCmdStatusStruct response = [self doGetXXXCommand:kAcqiris_GetMemory cmdArgs:args];
	if(response.status == 0){
		NSArray* args = [[NSString stringWithCString:response.responseBuffer encoding:NSASCIIStringEncoding] componentsSeparatedByString:@","];
		NSLog(@"Number Samples: %@\n",[args objectAtIndex:0]);
	}
	return response.status;
}

- (void) getOneWaveform:(BOOL)state
{
	if(!state){	
		[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(getOneWaveform) object:nil];
		[self setSamplingWaveforms:NO];	
	}
	else {
		[self initBoard];
		[self getOneWaveform];
	}
}


- (void) getOneWaveform
{
	
	if(!samplingWaveforms && readContinously) [self setSamplingWaveforms:YES];
	
	SBC_Packet aPacket;
	aPacket.cmdHeader.destination	  = kAcqirisDC440;
	aPacket.cmdHeader.cmdID			  = kAcqiris_Get1WaveForm;
	aPacket.cmdHeader.numberBytesinPayload	  = sizeof(Acquiris_ReadDataRequest);
	Acquiris_ReadDataRequest* request = (Acquiris_ReadDataRequest*)aPacket.payload;
	request->boardID				  = (uint32_t)boardID;
	request->numberSamples			  = (uint32_t)numberSamples;
	request->enableMask				  = 0x3;
	request->dataID					  = 0;
	request->location				  = (uint32_t)((([self crateNumber]&0x000000f)<<21) | (([self stationNumber]& 0x0000001f)<<16));
	
	[[self adapter] send:&aPacket receive:&aPacket];
	Acquiris_WaveformResponseStruct* wPtr = (Acquiris_WaveformResponseStruct*)aPacket.payload;
	int32_t numRecords = wPtr->numWaveformStructsToFollow;
	
	Acquiris_OrcaWaveformStruct* recordPtr = (Acquiris_OrcaWaveformStruct*)(wPtr+1);
	int j;
	for(j=0;j<numRecords;j++){
		int32_t recordLen = ExtractLength(recordPtr->orcaHeader);
		short channel = (recordPtr->location & 0x0000ff00) >> 8;
		if(channel<0 || channel>=2) break;
		
		lengthBuffer[channel] = recordPtr->numShorts- recordPtr->offsetToValidData;
		
		short* dataPtr = (short*)(recordPtr+1);	//get pointer to start of the data
		
		int i;
		int n = recordPtr->numShorts - recordPtr->offsetToValidData;
		int start = recordPtr->offsetToValidData;
		for(i=0;i<n;i++){
			tempBuffer[channel][i] = dataPtr[start+i];
		}
		//move the recordPtr to the next record
		recordPtr = (Acquiris_OrcaWaveformStruct*)((int32_t*)(recordPtr) + recordLen); //point to next recordStart
	}
	
	[[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440DataChanged object:self];
	
	[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(getOneWaveform) object:nil];
	
	if(readContinously && ![gOrcaGlobals runInProgress]){
		[self performSelector:@selector(getOneWaveform) withObject:nil afterDelay:.3];
	}
	else [self setSamplingWaveforms:NO];
	
}


- (Acquiris_GetCmdStatusStruct) doGetXXXCommand:(uint32_t)aCmdNumber cmdArgs:(NSString*)args
{
	Acquiris_GetCmdStatusStruct response;
	SBC_Packet aPacket;
	aPacket.cmdHeader.destination	= kAcqirisDC440;
	aPacket.cmdHeader.cmdID			= (uint32_t)aCmdNumber;
	aPacket.cmdHeader.numberBytesinPayload	= sizeof(Acquiris_AsciiCmdStruct);
	
	Acquiris_AsciiCmdStruct* cmdPtr = (Acquiris_AsciiCmdStruct*)aPacket.payload;
	if([args length]){
		strncpy(cmdPtr->argBuffer,[args cStringUsingEncoding:NSASCIIStringEncoding],kMaxAsciiCmdLength);
	}
	else cmdPtr->argBuffer[0]='\0';
	
	[[self adapter] send:&aPacket receive:&aPacket];
	memcpy(&response, aPacket.payload, sizeof(Acquiris_GetCmdStatusStruct));
	
	return response;
}

- (int32_t) doSetXXXCommand:(uint32_t)aCmdNumber cmdArgs:(NSString*)args
{
	int32_t status = 0;
	SBC_Packet aPacket;
	aPacket.cmdHeader.destination	= kAcqirisDC440;
	aPacket.cmdHeader.cmdID			= (uint32_t)aCmdNumber;
	aPacket.cmdHeader.numberBytesinPayload	= sizeof(Acquiris_AsciiCmdStruct);
	
	Acquiris_AsciiCmdStruct* cmdPtr = (Acquiris_AsciiCmdStruct*)aPacket.payload;
	if([args length]){
		strncpy(cmdPtr->argBuffer,[args cStringUsingEncoding:NSASCIIStringEncoding],kMaxAsciiCmdLength);
	}
	else cmdPtr->argBuffer[0]='\0';
	[[self adapter] send:&aPacket receive:&aPacket];
	
	Acquiris_SetCmdStatusStruct *responsePtr = (Acquiris_SetCmdStatusStruct*)aPacket.payload;
	status = responsePtr->status;
	return status;
}

- (int32_t) doCommand:(uint32_t)aCmdNumber cmdArgs:(NSString*)args
{
	int32_t status = 0;
	SBC_Packet aPacket;
	aPacket.cmdHeader.destination	= kAcqirisDC440;
	aPacket.cmdHeader.cmdID			= (uint32_t)aCmdNumber;
	aPacket.cmdHeader.numberBytesinPayload	= sizeof(Acquiris_AsciiCmdStruct);
	
	Acquiris_AsciiCmdStruct* cmdPtr = (Acquiris_AsciiCmdStruct*)aPacket.payload;
	if([args length]){
		strncpy(cmdPtr->argBuffer,[args cStringUsingEncoding:NSASCIIStringEncoding],kMaxAsciiCmdLength);
	}
	else cmdPtr->argBuffer[0]='\0';
	[[self adapter] send:&aPacket receive:&aPacket];
	Acquiris_StatusStruct *responsePtr = (Acquiris_StatusStruct*)aPacket.payload;
	status = responsePtr->status;
	return status;
}

- (void) initBoard
{
	[self setConfigureHorizontal];
	[self setConfigureMemory];
	[self setConfigureVertical:1];
	[self setConfigureVertical:2];
	[self setConfigureTrigClass];
	[self setConfigureTrigSource];
}

- (void) loadDialog
{
    @try {
		if([[self adapter] isConnected]){
			[self getMemory];
			[self getHorizontal];
			[self getVertical];
			[self getNumberChannels];
			[self getTriggerSource];
			[self getTriggerClass];
		}
	}
	@catch(NSException* localException) {
	}
}

#pragma mark 본벣ata Taker
- (void) setDataIds:(id)assigner
{
    dataId       = [assigner assignDataIds:kLongForm];
}

- (void) syncDataIdsWith:(id)anotherCard
{
    [self setDataId:[anotherCard dataId]];
}

- (NSDictionary*) dataRecordDescription
{
    NSMutableDictionary* dataDictionary = [NSMutableDictionary dictionary];
    NSDictionary* aDictionary = [NSDictionary dictionaryWithObjectsAndKeys:
								 @"ORAcqirisDC440DecoderForWaveform",            @"decoder",
								 [NSNumber numberWithLong:dataId],               @"dataId",
								 [NSNumber numberWithBool:YES],                  @"variable",
								 [NSNumber numberWithLong:-1],					@"length",
								 nil];
    [dataDictionary setObject:aDictionary forKey:@"Waveform"];
    
    return dataDictionary;
}

- (int) load_HW_Config_Structure:(SBC_crate_config*)configStruct index:(int)index
{
	configStruct->total_cards++;
	configStruct->card_info[index].hw_type_id	= kAcqirisDC440;		//better be unique
	configStruct->card_info[index].hw_mask[0] 	= dataId;		//better be unique
	configStruct->card_info[index].slot			= (uint32_t)[self stationNumber];
	configStruct->card_info[index].crate		= [self crateNumber];
	configStruct->card_info[index].base_add		= boardID;
	configStruct->card_info[index].deviceSpecificData[0] = numberSamples;
	configStruct->card_info[index].deviceSpecificData[1] = enableMask;
	configStruct->card_info[index].deviceSpecificData[2] = 1; // Tells the card to auto restart
	configStruct->card_info[index].deviceSpecificData[3] = 1; // Use the circular buffer
	configStruct->card_info[index].num_Trigger_Indexes = 0;		//N/A
	configStruct->card_info[index].next_Card_Index 	= index+1;	
	return index+1;
}


- (void) runTaskStarted:(ORDataPacket*)aDataPacket userInfo:(NSDictionary*)userInfo
{
	[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(getOneWaveform) object:nil];
	[self setSamplingWaveforms:NO];
	
	//    if(![self connected]){
	//		[NSException raise:@"Not Connected" format:@"No connection to crate."];
	//    }
	
    //----------------------------------------------------------------------------------------
    // first add our description to the data description
    
    [aDataPacket addDataDescriptionItem:[self dataRecordDescription] forKey:@"ORAcqirisDC440Model"];    
    
    //----------------------------------------------------------------------------------------
    controller = [self adapter]; //cache the controller for alittle bit more speed.
    location   = (uint32_t)((([self crateNumber]&0x000000f)<<21) | (([self stationNumber]& 0x0000001f)<<16));
	
    //[self clearExceptionCount];
    if([[userInfo objectForKey:@"doinit"]intValue]){
		[self initBoard];
	}
    [self startRates];
	firstTime = YES;
	isRunning = NO;
	
	//clear out the sampled waveforms
	lengthBuffer[0] = 0;
	lengthBuffer[1] = 0;
	[[NSNotificationCenter defaultCenter] postNotificationName:ORAcqirisDC440DataChanged object:self];
}

//**************************************************************************************
// Function:	TakeData
// Description: Read data from a card
//**************************************************************************************
-(void) takeData:(ORDataPacket*)aDataPacket userInfo:(NSDictionary*)userInfo
{
    @try {
		if(!firstTime){
			if([self dataAvailable]){
				
				[[self adapter] send:&readDataPacket receive:&returnPacket];
				
				Acquiris_WaveformResponseStruct* wPtr = (Acquiris_WaveformResponseStruct*)returnPacket.payload;
				int32_t hitMask = wPtr->hitMask;
				if(hitMask & 0x1)	sampleCount[0]++;
				if(hitMask & 0x2)	sampleCount[1]++;
				wPtr++;
				uint32_t* dp = (uint32_t*)wPtr;
				uint32_t totalDataLength = (returnPacket.cmdHeader.numberBytesinPayload - sizeof(Acquiris_WaveformResponseStruct))/sizeof(int32_t);
				if(totalDataLength){
					[aDataPacket addLongsToFrameBuffer:dp length:totalDataLength];			
				}
			}
		}
		else {
			isRunning = YES;
			uint32_t status = [self startAcquisition];
			
			//cache a data structure
			readDataPacket.cmdHeader.destination = kAcqirisDC440;
			readDataPacket.cmdHeader.cmdID		 = kAcqiris_GetDataRequest;
			readDataPacket.cmdHeader.numberBytesinPayload	 = sizeof(Acquiris_ReadDataRequest);
			Acquiris_ReadDataRequest* p			 = (Acquiris_ReadDataRequest*)readDataPacket.payload;
			p->boardID			= boardID;
			p->numberSamples	= numberSamples;
			p->dataID			= dataId;
			p->location			= location;
			p->enableMask		= enableMask;
			
			if(status != 0){
                [NSException raise:@"Acqiris DC440 Card Error" format:@"Crate: %d Card: %d Status=%d",[self crateNumber],[self stationNumber],status];
			}
			firstTime = NO;
		}
	}
	@catch(NSException* localException) {
		NSLogError(@"Acqiris DC440 Card Error",nil);
		[self incExceptionCount];
		[localException raise];
	}
	
}


- (void) runTaskStopped:(ORDataPacket*)aDataPacket userInfo:(NSDictionary*)userInfo
{
    [sampleRateGroup stop];
	[self stopAcquisition];
	isRunning = NO;
}

- (void) reset
{
}

#pragma mark 본Rates
- (BOOL) bumpRateFromDecodeStage:(short)channel
{
	if(isRunning)return NO;
    
    ++sampleCount[channel];
    return YES;
}

- (uint32_t) sampleCount:(int)aChannel
{
    return sampleCount[aChannel];
}

-(void) startRates
{
	[self clearSampleCounts];
    [sampleRateGroup start:self];
}

- (void) clearSampleCounts
{
    int i;
    for(i=0;i<2;i++){
		sampleCount[i]=0;
    }
}

- (uint32_t) getCounter:(int)counterTag forGroup:(int)groupTag
{
	if(groupTag == 0){
		if(counterTag>=0 && counterTag<2){
			return sampleCount[counterTag];
		}	
		else return 0;
	}
	else return 0;
}

#pragma mark 본베rchival
- (id) initWithCoder:(NSCoder*)decoder
{
	self = [super initWithCoder:decoder];
	[[self undoManager] disableUndoRegistration];
	[self setEnableMask:[decoder decodeIntegerForKey:@"enableMask"]];
	[self setReadContinously:[decoder decodeBoolForKey:@"readContinously"]];
	[self setTriggerSlope:[decoder decodeIntForKey:@"triggerSlope"]];
	[self setTriggerCoupling:[decoder decodeIntForKey:@"triggerCoupling"]];
	[self setTriggerSource:[decoder decodeIntForKey:@"triggerSource"]];
	[self setCoupling:[decoder decodeIntForKey:@"coupling"]];
	[self setVerticalOffset:[decoder decodeDoubleForKey:@"verticalOffset"]];
	[self setFullScale:[decoder decodeIntForKey:@"fullScaleIndex"]];
	[self setSampleInterval:[decoder decodeDoubleForKey:@"sampleInterval"]];
	[self setNumberSamples:[decoder decodeIntForKey:@"numberSamples"]];
	[self setDelayTime:[decoder decodeDoubleForKey:@"delayTime"]];
    [self setSampleRateGroup:[decoder decodeObjectForKey:@"sampleRateGroup"]];
	triggerLevels = [[decoder decodeObjectForKey:@"triggerLevels"] retain];
	
	if(!triggerLevels){
		triggerLevels = [[NSMutableArray arrayWithObjects:[NSNumber numberWithDouble:0],[NSNumber numberWithDouble:1],nil] retain];
	}
	
    if(!sampleRateGroup){
	    [self setSampleRateGroup:[[[ORRateGroup alloc] initGroup:2 groupTag:0] autorelease]];
	    [sampleRateGroup setIntegrationTime:5];
    }
    [self startRates];
    [sampleRateGroup resetRates];
    [sampleRateGroup calcRates];
	
	[[self undoManager] enableUndoRegistration];
	return self;
}
- (void) encodeWithCoder:(NSCoder*)encoder
{
	[super encodeWithCoder:encoder];
	[encoder encodeInteger:enableMask forKey:@"enableMask"];
	[encoder encodeBool:readContinously forKey:@"readContinously"];
	[encoder encodeInteger:triggerSlope    forKey:@"triggerSlope"];
	[encoder encodeObject:triggerLevels forKey:@"triggerLevels"];
	[encoder encodeInteger:triggerCoupling forKey:@"triggerCoupling"];
	[encoder encodeInteger:triggerSource  forKey:@"triggerSource"];
	[encoder encodeInteger:coupling forKey:@"coupling"];
	[encoder encodeDouble:verticalOffset forKey:@"verticalOffset"];
	[encoder encodeInteger:fullScale forKey:@"fullScaleIndex"];
	[encoder encodeDouble:sampleInterval forKey:@"sampleInterval"];
	[encoder encodeDouble:delayTime forKey:@"delayTime"];
	[encoder encodeInt:numberSamples forKey:@"numberSamples"];
    [encoder encodeObject:[self sampleRateGroup] forKey:@"sampleRateGroup"];
}

- (NSMutableDictionary*) addParametersToDictionary:(NSMutableDictionary*)dictionary
{
    
    NSMutableDictionary* objDictionary = [super addParametersToDictionary:dictionary];
    [objDictionary setObject:[NSNumber numberWithInteger:numberSamples] forKey:@"numberSamples"];
    [objDictionary setObject:[NSNumber numberWithDouble:delayTime] forKey:@"delayTime"];
    [objDictionary setObject:[NSNumber numberWithDouble:sampleInterval] forKey:@"sampleInterval"];
    [objDictionary setObject:[NSNumber numberWithInt:fullScale] forKey:@"fullScale"];
    [objDictionary setObject:[NSNumber numberWithDouble:verticalOffset] forKey:@"verticalOffset"];
    [objDictionary setObject:[NSNumber numberWithInt:coupling] forKey:@"verticalCoupling"];
    [objDictionary setObject:[NSNumber numberWithInt:triggerSource] forKey:@"triggerSource"];
    [objDictionary setObject:[NSNumber numberWithInt:triggerCoupling] forKey:@"triggerCoupling"];
    [objDictionary setObject:triggerLevels forKey:@"triggerLevels"];
    [objDictionary setObject:[NSNumber numberWithInt:triggerSlope] forKey:@"triggerSlope"];
    
	return objDictionary;
}

#pragma mark 본벧W Wizard

- (int) numberOfChannels
{
    return 2;
}
- (BOOL) hasParmetersToRamp
{
	return YES;
}
- (NSArray*) wizardParameters
{
    NSMutableArray* a = [NSMutableArray array];
    ORHWWizParam* p;
    
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"NumberSamples"];
    [p setFormat:@"##0" upperLimit:10000 lowerLimit:100 stepSize:1 units:@""];
    [p setSetMethod:@selector(setNumberSamples:) getMethod:@selector(numberSamples)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"DelayTime"];
    //[p setFormatter:[[[OHexFormatter alloc] init] autorelease]];
    [p setFormat:@"##0.0000" upperLimit:1000 lowerLimit:0 stepSize:1 units:@"uS"];
    [p setSetMethod:@selector(setDelayTime:) getMethod:@selector(delayTime)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"SampleInterval"];
    [p setFormat:@"##0.0000" upperLimit:1000 lowerLimit:0 stepSize:1 units:@"uS"];
    [p setSetMethod:@selector(setSampleInterval:) getMethod:@selector(sampleInterval)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"FullScale"];
    [p setFormat:@"##0.00" upperLimit:1000 lowerLimit:0 stepSize:1 units:@"V"];
    [p setSetMethod:@selector(setFullScaleFromValue:) getMethod:@selector(fullScale)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"VerticalOffset"];
    [p setFormat:@"##0.0000" upperLimit:10 lowerLimit:0 stepSize:1 units:@"V"];
    [p setSetMethod:@selector(setVerticalOffset:) getMethod:@selector(verticalOffset)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"VerticalCoupling"];
    [p setFormat:@"##0" upperLimit:4 lowerLimit:0 stepSize:1 units:@""];
    [p setSetMethod:@selector(setCoupling:) getMethod:@selector(coupling)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"TriggerSource"];
    [p setFormat:@"##0" upperLimit:2 lowerLimit:0 stepSize:1 units:@""];
    [p setSetMethod:@selector(setTriggerSource:) getMethod:@selector(triggerSource)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"TriggerCoupling"];
    [p setFormat:@"##0" upperLimit:4 lowerLimit:0 stepSize:1 units:@""];
    [p setSetMethod:@selector(setTriggerCoupling:) getMethod:@selector(triggerCoupling)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"TriggerLevel"];
    [p setFormat:@"##0" upperLimit:100 lowerLimit:0 stepSize:1 units:@"%/mV"];
    [p setSetMethod:@selector(setTriggerLevel:withValue:) getMethod:@selector(triggerLevel:)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setName:@"TriggerSlope"];
    [p setFormat:@"##0" upperLimit:5 lowerLimit:0 stepSize:1 units:@""];
    [p setSetMethod:@selector(setTriggerSlope:) getMethod:@selector(triggerSlope)];
	[p setInitMethodSelector:@selector(initBoard)];
    [a addObject:p];
	
	
    p = [[[ORHWWizParam alloc] init] autorelease];
    [p setUseValue:NO];
    [p setName:@"Init"];
    [p setSetMethodSelector:@selector(initBoard)];
    [a addObject:p];
    
    return a;
}

- (NSArray*) wizardSelections
{
    NSMutableArray* a = [NSMutableArray array];
    [a addObject:[ORHWWizSelection itemAtLevel:kContainerLevel name:@"Crate" className:@"ORcPCICrateModel"]];
    [a addObject:[ORHWWizSelection itemAtLevel:kObjectLevel name:@"Card" className:@"ORAcqirisDC440Model"]];
    [a addObject:[ORHWWizSelection itemAtLevel:kChannelLevel name:@"Channel" className:@"ORAcqirisDC440Model"]];
    return a;
	
}

- (NSNumber*) extractParam:(NSString*)param from:(NSDictionary*)fileHeader forChannel:(int)aChannel
{
	NSDictionary* cardDictionary = [self findCardDictionaryInHeader:fileHeader];
    if([param isEqualToString:@"NumberSamples"])return [[cardDictionary objectForKey:@"numberSamples"] objectAtIndex:aChannel];
    else if([param isEqualToString:@"DelayTime"]) return [cardDictionary objectForKey:@"delayTime"];
    else if([param isEqualToString:@"SampleInterval"]) return [cardDictionary objectForKey:@"sampleInterval"];
    else if([param isEqualToString:@"FullScale"]) return [cardDictionary objectForKey:@"fullScale"];
    else if([param isEqualToString:@"VerticalOffset"]) return [cardDictionary objectForKey:@"verticalOffset"];
    else if([param isEqualToString:@"VerticalCoupling"]) return [cardDictionary objectForKey:@"verticalCoupling"];
    else if([param isEqualToString:@"TriggerSource"]) return [cardDictionary objectForKey:@"triggerSource"];
    else if([param isEqualToString:@"TriggerCoupling"]) return [cardDictionary objectForKey:@"triggerCoupling"];
    else if([param isEqualToString:@"TriggerLevel"]) return [cardDictionary objectForKey:@"triggerLevels"];
    else if([param isEqualToString:@"TriggerSlope"]) return [cardDictionary objectForKey:@"triggerSlope"];
    else return nil;
}


- (int) lengthBuffer:(int)set
{
	return lengthBuffer[set];
}
- (float) buffer:(int)x set:(int)set
{
	if(set==0)return (float)tempBuffer[set][x];
	else      return (float)tempBuffer[set][x];
}

@end

